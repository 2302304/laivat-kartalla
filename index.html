<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Laivojen reaaliaikainen sijainti</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      h1 {
        margin-top: 0;
        margin-bottom: 15px;
      }

      #map {
        flex: 1;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 5px;
        min-height: 0;
      }

      .info-panel {
        background: white;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .ship-info {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .info-item {
        flex: 1;
        min-width: 150px;
      }

      .info-label {
        font-weight: bold;
        color: #666;
      }

      .info-value {
        font-size: 1.2em;
        color: #333;
        margin-top: 5px;
      }

      .speed {
        color: #007bff;
      }

      .ship-number {
        color: #28a745;
      }

      #showAllShips {
        margin-top: 10px;
        padding: 8px 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      #showAllShips:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <h1>Laivojen reaaliaikainen sijainti</h1>

    <div class="info-panel">
      <div class="ship-info">
        <div class="info-item">
          <div class="info-label">Valittu laiva:</div>
          <div class="info-value ship-number" id="shipMmsi">Kaikki laivat</div>
        </div>
        <div class="info-item">
          <div class="info-label">Nopeus:</div>
          <div class="info-value speed" id="speed">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">Sijainti:</div>
          <div class="info-value" id="coordinates">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">PÃ¤ivitetty:</div>
          <div class="info-value" id="timestamp">-</div>
        </div>
      </div>
      <!-- UUSI NAPPI -->
      <button id="showAllShips" onclick="showAllShips()">NÃ¤ytÃ¤ kaikki laivat</button>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      const map = L.map("map").setView([61.5, 20.0], 6);

      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
        maxZoom: 19,
      }).addTo(map);

      let shipMarkers = [];
      let selectedShip = null;

      function createShipIcon(mmsi, isSelected = false) {
        const color = isSelected ? "#dc3545" : "#007bff";
        const size = isSelected ? 35 : 25;
        const content = isSelected ? "ðŸš¢" : mmsi;

        return L.divIcon({
          className: "ship-marker",
          html: `
            <div style="
                background: ${color};
                color: white;
                border-radius: 50%;
                width: ${size}px;
                height: ${size}px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: ${isSelected ? "16px" : "10px"};
                border: 3px solid white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                cursor: pointer;
            ">${content}</div>
          `,
          iconSize: [size, size],
          iconAnchor: [size / 2, size / 2],
        });
      }

      function updateSelectedShipInfo(ship) {
        const coords = ship.geometry.coordinates;
        const lat = coords[1];
        const lng = coords[0];

        document.getElementById("shipMmsi").textContent = `MMSI ${ship.mmsi}`;
        document.getElementById("speed").textContent =
          ship.speedKmh.toFixed(1) + " km/h";
        document.getElementById("coordinates").textContent = `${ship.city || "Tuntematon"} (${lat.toFixed(6)}, ${lng.toFixed(6)})`;

        const timestamp = new Date(ship.properties.timestampExternal);
        const weatherInfo = ship.weather
          ? ` | ${ship.weather.temperature}Â°C, ${ship.weather.description}`
          : "";
        document.getElementById("timestamp").textContent =
          timestamp.toLocaleString("fi-FI") + weatherInfo;
      }

      function displayAllShips(ships) {
        if (selectedShip) return;

        shipMarkers.forEach((marker) => map.removeLayer(marker));
        shipMarkers = [];

        ships.forEach((ship) => {
          const coords = ship.geometry.coordinates;
          const lat = coords[1];
          const lng = coords[0];

          const marker = L.marker([lat, lng], {
            icon: createShipIcon(ship.mmsi, false),
            riseOnHover: true,
          }).addTo(map);

          marker.on("click", function () {
            selectShip(ship);
          });

          shipMarkers.push(marker);
        });
      }

      function selectShip(ship) {
        selectedShip = ship;

        fetch(`http://localhost:3000/api/ships/${ship.mmsi}`)
          .then((response) => response.json())
          .then((shipWithDetails) => {
            const coords = shipWithDetails.geometry.coordinates;
            const lat = coords[1];
            const lng = coords[0];

            shipMarkers.forEach((marker) => map.removeLayer(marker));
            shipMarkers = [];

            const marker = L.marker([lat, lng], {
              icon: createShipIcon(shipWithDetails.mmsi, true),
            }).addTo(map);

            shipMarkers.push(marker);

            map.setView([lat, lng], 10);

            updateSelectedShipInfo(shipWithDetails);
          });
      }

      // NÃ¤ytÃ¤ kaikki laivat -nappi
      function showAllShips() {
        selectedShip = null;
        document.getElementById("shipMmsi").textContent = "Kaikki laivat";
        document.getElementById("speed").textContent = "-";
        document.getElementById("coordinates").textContent = "-";
        document.getElementById("timestamp").textContent = "-";

        fetchAllShips().then(displayAllShips);
        map.setView([61.5, 20.0], 6); // reset nÃ¤kymÃ¤ Suomeen
      }

      function fetchAllShips() {
        return fetch("http://localhost:3000/api/ships")
          .then((response) => response.json())
          .catch((error) => {
            console.error("Virhe haettaessa laivoja:", error);
            return [];
          });
      }

      fetchAllShips().then((ships) => {
        if (ships && ships.length > 0) {
          displayAllShips(ships);
        } else {
          console.warn("Ei laivoja saatavilla.");
        }
      });
    </script>
  </body>
</html>
